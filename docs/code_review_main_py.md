# Code Review: main.py - Endpoints –¥–ª—è Tasks –∏ Users

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–¥–µ–ª–∏, endpoints, –∏ lifecycle management
2. **Type hints** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤
3. **Docstrings** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Google style
4. **Error handling** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π asyncpg
5. **Dependency Injection** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Depends()` –¥–ª—è database connections

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå ‚Üí ‚úÖ –û—à–∏–±–∫–∞ –≤ `delete_task`

**–ë—ã–ª–æ:**
```python
await conn.execute("DELETE FROM tasks WHERE id = $1 RETURNING id", task_id)
if not row:  # ‚ùå row –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!
    raise HTTPException(...)
```

**–°—Ç–∞–ª–æ:**
```python
deleted_id = await conn.fetchval(
    "DELETE FROM tasks WHERE id = $1 RETURNING id",
    task_id,
)
if deleted_id is None:  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
    raise HTTPException(...)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `conn.execute()` –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `conn.fetchval()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ ID.

---

### 2. ‚ùå ‚Üí ‚úÖ `update_task` –æ–±–Ω–æ–≤–ª—è–ª –≤—Å–µ –ø–æ–ª—è, –¥–∞–∂–µ None

**–ë—ã–ª–æ:**
```python
UPDATE tasks
SET title = $1, description = $2, status_id = $3, ...
WHERE id = $7
```
–í—Å–µ –ø–æ–ª—è –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ `None`.

**–°—Ç–∞–ª–æ:**
```python
# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-None –ø–æ–ª–µ–π
if task.title is not None:
    update_fields.append(f"title = ${param_index}")
    values.append(task.title)
    param_index += 1
# ... –∏ —Ç–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `{"title": null}`, –ø–æ–ª–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å –±—ã –Ω–∞ `NULL`, —á—Ç–æ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã (–Ω–µ `None`).

---

### 3. ‚ùå ‚Üí ‚úÖ –£–¥–∞–ª–µ–Ω—ã –Ω–µ–Ω—É–∂–Ω—ã–µ –º–æ–¥–µ–ª–∏

**–ë—ã–ª–æ:**
```python
class TaskDelete(BaseModel):
    id: int

class UserDelete(BaseModel):
    id: int
```

**–°—Ç–∞–ª–æ:** –ú–æ–¥–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã.

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è DELETE endpoints –Ω–µ –Ω—É–∂–Ω—ã –º–æ–¥–µ–ª–∏ - `task_id` –∏ `user_id` —É–∂–µ –≤ path –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.

---

### 4. ‚ùå ‚Üí ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `update_task` –∏ `update_user`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
if not any([
    task.title is not None,
    task.description is not None,
    # ...
]):
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail="At least one field must be provided for update",
    )
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç `{}` –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –ø–µ—Ä–µ–¥–∞–Ω–æ.

---

### 5. ‚ùå ‚Üí ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
update_fields.append("updated_at = NOW()")
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `updated_at` –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏.

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å `updated_at` –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏.

---

### 6. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã endpoints –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª–Ω—ã–µ CRUD endpoints:
- `POST /users` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /users/{user_id}` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /users/{user_id}` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `DELETE /users/{user_id}` - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
user.password,  # TODO: Replace with hashed password
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
import bcrypt

# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:
password_hash = bcrypt.hashpw(user.password.encode(), bcrypt.gensalt()).decode()
# –°–æ—Ö—Ä–∞–Ω—è—Ç—å password_hash –≤–º–µ—Å—Ç–æ user.password
```

**–í–∞–∂–Ω–æ:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –≤ plain text!

---

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ Pydantic –º–æ–¥–µ–ª–∏:

```python
from pydantic import EmailStr, Field, validator

class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=64)
    email: EmailStr  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
    password: str = Field(..., min_length=8)
    
    @validator('password')
    def validate_password(cls, v):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        if not any(c.isupper() for c in v):
            raise ValueError('Password must contain uppercase letter')
        return v
```

---

### 3. SQL Injection –∑–∞—â–∏—Ç–∞

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (–±–µ–∑–æ–ø–∞—Å–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å):**
```python
query = f"""
    UPDATE tasks
    SET {', '.join(update_fields)}
    WHERE id = ${param_index}
"""
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —è–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å whitelist –¥–ª—è –∏–º–µ–Ω –ø–æ–ª–µ–π
ALLOWED_UPDATE_FIELDS = {'title', 'description', 'status_id', ...}

for field, value in task.dict(exclude_unset=True).items():
    if field in ALLOWED_UPDATE_FIELDS:
        update_fields.append(f"{field} = ${param_index}")
        values.append(value)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–µ–∫—É—â–∏–π –∫–æ–¥ –±–µ–∑–æ–ø–∞—Å–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã, –∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

---

### 4. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω—è—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```python
async with conn.transaction():
    # –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É
    await conn.execute("UPDATE tasks ...")
    # –û–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    await conn.execute("UPDATE task_assignee ...")
```

---

### 5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```python
import logging

logger = logging.getLogger(__name__)

async def create_task(...):
    logger.info(f"Creating task: {task.title}")
    try:
        # ...
        logger.info(f"Task created with ID: {row['id']}")
    except Exception as e:
        logger.error(f"Failed to create task: {e}")
        raise
```

---

### 6. Pagination –¥–ª—è —Å–ø–∏—Å–∫–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç–µ endpoints –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `GET /tasks`), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ pagination:

```python
@app.get("/tasks")
async def list_tasks(
    skip: int = 0,
    limit: int = 100,
    conn: Annotated[asyncpg.Connection, Depends(get_db_connection)],
):
    rows = await conn.fetch(
        "SELECT * FROM tasks LIMIT $1 OFFSET $2",
        limit,
        skip,
    )
    return [TaskResponse(**row) for row in rows]
```

---

### 7. Response –º–æ–¥–µ–ª–∏ –±–µ–∑ –ø–∞—Ä–æ–ª–µ–π

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - `UserResponse` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `password`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–∞—Ä–æ–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------|--------|-------------|
| –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, —Ö–æ—Ä–æ—à–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è |
| Type hints | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã |
| Docstrings | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è |
| Error handling | ‚úÖ –•–æ—Ä–æ—à–æ | –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è | –ù—É–∂–Ω–æ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π |
| –í–∞–ª–∏–¥–∞—Ü–∏—è | ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å | –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ Pydantic |
| SQL –∑–∞–ø—Ä–æ—Å—ã | ‚úÖ –•–æ—Ä–æ—à–æ | –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ |

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏

1. **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (bcrypt)
2. **–í–∞–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ Pydantic –º–æ–¥–µ–ª–∏
3. **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å pagination –¥–ª—è —Å–ø–∏—Å–∫–æ–≤

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ö–æ–¥ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–ª–µ–¥—É–µ—Ç best practices –¥–ª—è FastAPI –∏ asyncpg. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ì–ª–∞–≤–Ω–æ–µ - –¥–æ–±–∞–≤–∏—Ç—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –ø–µ—Ä–µ–¥ production deployment.

**–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!** üéâ

