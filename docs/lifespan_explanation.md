# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è `lifespan` —Å `@asynccontextmanager`

## –ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """Manage database connection pool lifecycle."""
    global db_pool

    # Startup: create connection pool
    db_pool = await asyncpg.create_pool(...)
    print("Database connection pool created")

    yield

    # Shutdown: close connection pool
    await db_pool.close()
    print("Database connection pool closed")
```

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ `@asynccontextmanager`?

`@asynccontextmanager` - —ç—Ç–æ **–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä** –∏–∑ –º–æ–¥—É–ª—è `contextlib`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä**.

### –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:
–≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è:
1. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥ **–¥–æ** `yield` (startup)
2. **–ü–∞—É–∑–∏—Ä—É–µ—Ç** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ `yield`
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥ **–ø–æ—Å–ª–µ** `yield` (shutdown)

### –ê–Ω–∞–ª–æ–≥–∏—è:
–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —ç—Ç–æ –∫–∞–∫ **–æ—Ç–∫—Ä—ã—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å**:

```python
# –û–±—ã—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def open_door():
    print("–û—Ç–∫—Ä—ã–≤–∞—é –¥–≤–µ—Ä—å")
    # ... —á—Ç–æ-—Ç–æ –¥–µ–ª–∞–µ–º ...
    print("–ó–∞–∫—Ä—ã–≤–∞—é –¥–≤–µ—Ä—å")  # –ü—Ä–æ–±–ª–µ–º–∞: —ç—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Å—Ä–∞–∑—É!

# –° @asynccontextmanager
@asynccontextmanager
async def open_door():
    print("–û—Ç–∫—Ä—ã–≤–∞—é –¥–≤–µ—Ä—å")  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–ï–†–í–´–ú
    yield                    # –ü–ê–£–ó–ê - –¥–≤–µ—Ä—å –æ—Ç–∫—Ä—ã—Ç–∞, –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
    print("–ó–∞–∫—Ä—ã–≤–∞—é –¥–≤–µ—Ä—å")  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï–î–ù–ò–ú (–∫–æ–≥–¥–∞ –≤—ã—Ö–æ–¥–∏–º)
```

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `yield`?

`yield` - —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ Python, –∫–æ—Ç–æ—Ä–æ–µ:
1. **–ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
2. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç** –∑–Ω–∞—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç** —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
4. –ü–æ–∑–≤–æ–ª—è–µ—Ç **–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∑–∂–µ

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞:

```python
def simple_generator():
    print("–ù–∞—á–∞–ª–æ")
    yield "–ü–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"  # –§—É–Ω–∫—Ü–∏—è –ü–ê–£–ó–ò–†–£–ï–¢–°–Ø –∑–¥–µ—Å—å
    print("–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ")
    yield "–í—Ç–æ—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"   # –§—É–Ω–∫—Ü–∏—è –ü–ê–£–ó–ò–†–£–ï–¢–°–Ø –∑–¥–µ—Å—å
    print("–ö–æ–Ω–µ—Ü")

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
gen = simple_generator()
print(next(gen))  # –í—ã–≤–µ–¥–µ—Ç: "–ù–∞—á–∞–ª–æ" –∏ "–ü–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
print(next(gen))  # –í—ã–≤–µ–¥–µ—Ç: "–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ" –∏ "–í—Ç–æ—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
print(next(gen))  # –í—ã–≤–µ–¥–µ—Ç: "–ö–æ–Ω–µ—Ü" –∏ –≤—ã–∑–æ–≤–µ—Ç StopIteration
```

### –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ:

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # –ö–û–î –î–û YIELD - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–†–ò –°–¢–ê–†–¢–ï
    db_pool = await asyncpg.create_pool(...)
    print("Database connection pool created")
    
    yield  # –ü–ê–£–ó–ê - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–¥–µ—Å—å
    
    # –ö–û–î –ü–û–°–õ–ï YIELD - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–†–ò –û–°–¢–ê–ù–û–í–ö–ï
    await db_pool.close()
    print("Database connection pool closed")
```

---

## –ö–∞–∫ FastAPI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é?

–ö–æ–≥–¥–∞ –º—ã –ø–µ—Ä–µ–¥–∞–µ–º `lifespan=lifespan` –≤ `FastAPI()`:

```python
app = FastAPI(
    title="Task Tracker API",
    lifespan=lifespan,  # FastAPI –∑–Ω–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ lifecycle —Ñ—É–Ω–∫—Ü–∏—è
)
```

FastAPI –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

### 1. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (startup):

```python
# FastAPI –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ –¥–µ–ª–∞–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
async with lifespan(app):
    # –ö–æ–¥ –¥–æ yield –≤—ã–ø–æ–ª–Ω–µ–Ω
    # –¢–µ–ø–µ—Ä—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, endpoints –∏ —Ç.–¥.
    pass
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. FastAPI –≤—ã–∑—ã–≤–∞–µ—Ç `lifespan(app)`
2. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–¥ **–¥–æ** `yield`:
   - –°–æ–∑–¥–∞–µ—Ç—Å—è connection pool
   - –í—ã–≤–æ–¥–∏—Ç—Å—è "Database connection pool created"
3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ **–ø–∞—É–∑–∏—Ä—É–µ—Ç—Å—è** –Ω–∞ `yield`
4. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã)

### 2. –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (shutdown):

```python
# –ö–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, FastAPI –¥–µ–ª–∞–µ—Ç:
# –í—ã—Ö–æ–¥ –∏–∑ async with –±–ª–æ–∫–∞
# –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–¥ –ü–û–°–õ–ï yield
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. FastAPI –ø–æ–ª—É—á–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Ctrl+C, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞)
2. –í—ã—Ö–æ–¥–∏—Ç –∏–∑ `async with` –±–ª–æ–∫–∞
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–¥ **–ø–æ—Å–ª–µ** `yield`:
   - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è connection pool
   - –í—ã–≤–æ–¥–∏—Ç—Å—è "Database connection pool closed"

---

## –ü–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

### –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: uvicorn main:app --reload

‚Üì

FastAPI: "–ù–∞—á–∏–Ω–∞—é –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

‚Üì

FastAPI: "–í—ã–∑—ã–≤–∞—é lifespan(app)"

‚Üì

lifespan: "–í—ã–ø–æ–ª–Ω—è—é –∫–æ–¥ –î–û yield"
  ‚îú‚îÄ db_pool = await asyncpg.create_pool(...)
  ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç—Å—è 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î
  ‚îî‚îÄ print("Database connection pool created")

‚Üì

lifespan: "–î–æ—à–µ–ª –¥–æ yield, –ü–ê–£–ó–ò–†–£–Æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ"

‚Üì

FastAPI: "–ö–æ–¥ –¥–æ yield –≤—ã–ø–æ–ª–Ω–µ–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!"
  ‚îú‚îÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ
  ‚îú‚îÄ Endpoints –¥–æ—Å—Ç—É–ø–Ω—ã
  ‚îî‚îÄ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã
```

### –®–∞–≥ 2: –†–∞–±–æ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: GET /tasks/1

‚Üì

FastAPI: "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å"
  ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç endpoint get_task()
  ‚îú‚îÄ get_task() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db_pool (—É–∂–µ —Å–æ–∑–¥–∞–Ω!)
  ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç

‚Üì

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: POST /tasks

‚Üì

FastAPI: "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å"
  ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç endpoint create_task()
  ‚îú‚îÄ create_task() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db_pool (—É–∂–µ —Å–æ–∑–¥–∞–Ω!)
  ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç

... (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã) ...
```

### –®–∞–≥ 3: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: Ctrl+C (–∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞)

‚Üì

FastAPI: "–ü–æ–ª—É—á–∏–ª —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–∞—á–∏–Ω–∞—é shutdown"

‚Üì

FastAPI: "–í—ã—Ö–æ–∂—É –∏–∑ async with lifespan(app)"

‚Üì

lifespan: "–ü—Ä–æ–¥–æ–ª–∂–∞—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ü–û–°–õ–ï yield"
  ‚îú‚îÄ await db_pool.close()
  ‚îú‚îÄ –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
  ‚îî‚îÄ print("Database connection pool closed")

‚Üì

FastAPI: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
```

---

## –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
–í—Ä–µ–º—è ‚Üí
‚îÇ
‚îú‚îÄ [STARTUP]
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ lifespan() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ –ö–æ–¥ –î–û yield:
‚îÇ  ‚îÇ  ‚îú‚îÄ db_pool = await asyncpg.create_pool(...)  ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞
‚îÇ  ‚îÇ  ‚îî‚îÄ print("Database connection pool created")
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ yield  ‚Üê –ü–ê–£–ó–ê
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ [APPLICATION RUNNING]  ‚Üê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–¥–µ—Å—å
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ Request 1 ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db_pool
‚îÇ     ‚îú‚îÄ Request 2 ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db_pool
‚îÇ     ‚îú‚îÄ Request 3 ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db_pool
‚îÇ     ‚îî‚îÄ ... (–º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤) ...
‚îÇ
‚îú‚îÄ [SHUTDOWN]
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ –í—ã—Ö–æ–¥ –∏–∑ async with
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ –ö–æ–¥ –ü–û–°–õ–ï yield:
‚îÇ  ‚îÇ  ‚îú‚îÄ await db_pool.close()  ‚Üê –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—É–ª–∞
‚îÇ  ‚îÇ  ‚îî‚îÄ print("Database connection pool closed")
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ lifespan() –∑–∞–≤–µ—Ä—à–µ–Ω–∞
‚îÇ
‚îî‚îÄ [END]
```

---

## –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ `@asynccontextmanager`?

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±, deprecated):

```python
@app.on_event("startup")
async def startup():
    global db_pool
    db_pool = await asyncpg.create_pool(...)

@app.on_event("shutdown")
async def shutdown():
    await db_pool.close()
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î–≤–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–ª–æ–∂–Ω–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å)
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- Deprecated –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö FastAPI

### –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (–Ω–∞—à):

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup –∫–æ–¥
    db_pool = await asyncpg.create_pool(...)
    yield
    # Shutdown –∫–æ–¥
    await db_pool.close()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å–µ–≥–æ lifecycle
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: startup ‚Üí —Ä–∞–±–æ—Ç–∞ ‚Üí shutdown
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è FastAPI)
- –õ–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

---

## –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å `yield` –±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è?

–í –Ω–∞—à–µ–º –∫–æ–¥–µ:
```python
yield  # –ë–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ú—ã **–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º** –Ω–∏–∫–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ú—ã –ø—Ä–æ—Å—Ç–æ **–ø–∞—É–∑–∏—Ä—É–µ–º** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- FastAPI –Ω–µ –æ–∂–∏–¥–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç `yield`

### –ï—Å–ª–∏ –±—ã –º—ã –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ:

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    db_pool = await asyncpg.create_pool(...)
    yield db_pool  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É–ª
    await db_pool.close()
```

–¢–æ–≥–¥–∞ FastAPI –º–æ–≥ –±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ `db_pool`:
```python
async with lifespan(app) as pool:
    # pool - —ç—Ç–æ db_pool
    pass
```

–ù–æ –Ω–∞–º —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ `yield` –±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è.

---

## –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

```python
from contextlib import asynccontextmanager

@asynccontextmanager  # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä: –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –≤ async context manager
async def lifespan(app: FastAPI):  # FastAPI –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–µ–±—è –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
    """
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 3 —ç—Ç–∞–ø–∞:
    1. –ö–æ–¥ –î–û yield - startup (—Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
    2. yield - –ø–∞—É–∑–∞ (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    3. –ö–æ–¥ –ü–û–°–õ–ï yield - shutdown (–æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤)
    """
    global db_pool  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø—É–ª–∞

    # ========== –≠–¢–ê–ü 1: STARTUP ==========
    # –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    print("üöÄ –ù–∞—á–∏–Ω–∞—é startup...")
    
    db_pool = await asyncpg.create_pool(
        DATABASE_URL,
        min_size=10,
        max_size=20,
    )
    print("‚úÖ Database connection pool created")
    
    # ========== –≠–¢–ê–ü 2: YIELD (–ü–ê–£–ó–ê) ==========
    # –ó–¥–µ—Å—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ü–ê–£–ó–ò–†–£–ï–¢–°–Ø
    # FastAPI –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
    # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–¥–µ—Å—å
    yield  # <-- –ü–ê–£–ó–ê! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    
    # ========== –≠–¢–ê–ü 3: SHUTDOWN ==========
    # –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
    print("üõë –ù–∞—á–∏–Ω–∞—é shutdown...")
    
    await db_pool.close()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    print("‚úÖ Database connection pool closed")
    
    # –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
```

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)

FastAPI –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ –¥–µ–ª–∞–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ:

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥ —Ç–æ–≥–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç FastAPI:

async def run_app():
    # 1. –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = FastAPI(lifespan=lifespan)
    
    # 2. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:
    async with lifespan(app):  # –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é
        # –ö–æ–¥ –¥–æ yield –≤—ã–ø–æ–ª–Ω–µ–Ω (–ø—É–ª —Å–æ–∑–¥–∞–Ω)
        # yield - –ø–∞—É–∑–∞
        # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–¥–µ—Å—å
        await serve_requests(app)  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTTP –∑–∞–ø—Ä–æ—Å—ã
    
    # 3. –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ async with:
    # –ö–æ–¥ –ø–æ—Å–ª–µ yield –≤—ã–ø–æ–ª–Ω–µ–Ω (–ø—É–ª –∑–∞–∫—Ä—ã—Ç)
```

---

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. `yield` - —ç—Ç–æ –Ω–µ `return`

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç):
async def lifespan(app: FastAPI):
    db_pool = await asyncpg.create_pool(...)
    return  # –≠—Ç–æ –∑–∞–≤–µ—Ä—à–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é, shutdown –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è!
    await db_pool.close()

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
async def lifespan(app: FastAPI):
    db_pool = await asyncpg.create_pool(...)
    yield  # –ü–∞—É–∑–∞, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    await db_pool.close()  # –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ shutdown
```

### 2. –ö–æ–¥ –ø–æ—Å–ª–µ `yield` –í–°–ï–ì–î–ê –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

–î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    db_pool = await asyncpg.create_pool(...)
    yield
    # –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –í–°–ï–ì–î–ê, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    await db_pool.close()  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```

### 3. `app` –ø–∞—Ä–∞–º–µ—Ç—Ä

FastAPI –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–∞–º —Å–µ–±—è –≤ —Ñ—É–Ω–∫—Ü–∏—é:
```python
async def lifespan(app: FastAPI):
    # app - —ç—Ç–æ —ç–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ app.state, app.router –∏ —Ç.–¥.
    app.state.db_pool = db_pool  # –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ state
    yield
```

---

## –†–µ–∑—é–º–µ

1. **`@asynccontextmanager`** - –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä, –ø—Ä–µ–≤—Ä–∞—â–∞—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏—é –≤ async context manager
2. **`yield`** - –ø–∞—É–∑–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ä–∞–∑–¥–µ–ª—è—è startup –∏ shutdown –∫–æ–¥
3. **FastAPI** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
4. **–ö–æ–¥ –¥–æ yield** - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ startup (—Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
5. **–ö–æ–¥ –ø–æ—Å–ª–µ yield** - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ shutdown (–æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤)
6. **–ì–∞—Ä–∞–Ω—Ç–∏—è** - shutdown –∫–æ–¥ –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

–≠—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ FastAPI!


